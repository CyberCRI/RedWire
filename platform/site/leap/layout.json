{
  "action": "doInParallel",
  "children": [
    { 
      "send": {
        "services.graphics.shapes": "tools.drawShape({ type: 'rectangle', layer: 'bg', position: [0, 0], size: services.graphics.size, fillStyle: 'black' })" 
      }
    },
    {
      "action": "doInSequence",
      "params": {
        "in": {
          "activeChild": "model.activeChild"
        },
        "out": {
          "model.activeChild": "params.activeChild"
        }
      },
      "children": [
        { 
          "action": "doWhile",
          "params": {
            "in": {
              "value": "!model.ageForm.done"
            }
          },
          "children": [
            {
              "action": "updateHtmlTemplate",
              "params": {
                "in": {
                  "htmlService": "services.html",
                  "modelValues": "model.ageForm",
                  "assetName": "'form'",
                  "templateName": "'ageForm'"
                },
                "out": {
                  "services.html": "params.htmlService",
                  "model.ageForm": "params.modelValues"
                }
              }
            }
          ]
        },
        { 
          "send": {
            "model.blocks": "model.constants.initialBlocks"
          }
        },
        { 
          "action": "doWhile",
          "params": {
            "in": {
              "value": "!services.html.receive.blocksForm || !services.html.receive.blocksForm.values.done"
            }
          },
          "children": [
            {
              "action": "detectMouse",
              "params": {
                "in": {
                  "shapes": "tools.translateShapes(tools.inverseVector(model.gridTranslation), tools.makeMovableBlockShapes(model.constants.grid, model.blocks, model.constants.blockColor, model.constants.blockSize))",
                  "shape": "model.mouseDetection.shape",
                  "mousePosition": "services.mouse.position",
                  "mouseDown": "services.mouse.down",
                  "state": "model.mouseDetection.state",
                  "dragStartPosition": "model.mouseDetection.dragStartPosition"
                },
                "out": {
                  "model.mouseDetection.state": "params.state",
                  "model.mouseDetection.dragStartPosition": "params.dragStartPosition",
                  "model.mouseDetection.shape": "params.shape"
                }
              }
            },
            { 
              "send": {
                "services.graphics.shapes": "tools.drawShapes(tools.translateShapes(tools.inverseVector(model.gridTranslation), tools.makeBlockShapes(model.constants.grid, model.blocks, model.constants.blockColor, model.constants.blockSize)))"
              }
            },
            { 
              "send": {
                "services.graphics.shapes": "tools.drawShape({ layer: 'gallery', type: 'rectangle', position: [800, 0], size: [160, 100], fillStyle: 'grey', strokeStyle: 'white' })"
              }
            },
            {
              "send": {
                "model.gridTranslation": "tools.findCenterOfCells(model.constants.grid, model.blocks)"
              }
            },
            {
              "action": "when",
              "params": {
                "in": {
                  "value": "model.mouseDetection.state"
                }
              },
              "children": [
                {
                  "name": "drag",
                  "action": "if",
                  "params": {
                    "in": {
                      "value": "services.mouse.position != null"
                    }
                  },
                  "children": [
                    {
                      "send": {
                        "services.mouse.cursor": "'move'",
                        "services.graphics.shapes": "tools.drawShape(tools.makeDraggedShape(model.constants.blockSize, model.constants.blockColor, services.mouse.position))" 
                      }
                    }
                  ]
                },
                {
                  "name": "endDrag",
                  "send": { 
                    "model.blocks": "tools.moveBlock(model.constants.grid, model.blocks, model.mouseDetection.shape.meta, tools.translatePoint(model.gridTranslation, services.mouse.position))"
                  }
                },
                {
                  "name": "hover",
                  "send": {
                    "services.mouse.cursor": "'pointer'"
                  }  
                }
              ]
            },
            {
              "send": { 
                "services.html.send.blocksForm": "{ asset: 'blocksForm', values: { done: false, galleryShapeCount: model.gallery.length, ready: model.gallery.length >= 5 } }"
              }
            },
            { 
              "action": "if",
              "params": {
                "in": {
                  "value": "services.html.receive.blocksForm && services.html.receive.blocksForm.values.addShape"
                }
              },
              "children": [
                {
                  "send": {
                    "model.gallery" : "GE.append(model.gallery, model.blocks)"
                  }
                }
              ]
            },
            {
              "action": "if",
              "params": {
                "in": {
                  "value": "model.gallery.length > 0"
                }
              },
              "children": [
                { 
                  "send": {
                    "services.graphics.shapes": "tools.drawShapes(tools.translateShapes(tools.inverseVector(tools.findCenterOfCells(model.constants.galleryGrid, _.last(model.gallery))), tools.makeBlockShapes(model.constants.galleryGrid, _.last(model.gallery), model.constants.blockColor, model.constants.galleryBlockSize)))"
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
