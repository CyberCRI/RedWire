{
  "action": "group",
  "children": [
    { 
      "action": "drawImage",
      "params": {
        "out": {
          "services.graphics.shapes": "params.shapes"
        },
        "in": {
          "image": "'background'",
          "layer": "'bg'"
        }
      }
    },
    {
      "action": "doInSequence",
      "params": {
        "in": {
          "activeChild": "model.topLevelActiveChild"
        },
        "out": {
          "model.topLevelActiveChild": "params.activeChild"
        }
      },
      "children": [
        {
          "action": "doForSomeTime",
          "params": {
            "in": {
              "time": "model.constants.startingTime",
              "timer": "model.timer"
            },
            "out": {
              "model.timer": "params.timer"
            }
          },
          "children": [
            { 
              "action": "drawImage",
              "params": {
                "in": {
                  "image": "'title'",
                  "layer": "'pieces'",
                  "x": 100,
                  "y": 150
                },
                "out": {
                  "services.graphics.shapes": "params.shapes"
                }
              }
            },
            {
              "action": "drawText",
              "params": {
                "in": {
                  "text": "'Ready...'",
                  "x": 885,
                  "y": 150,
                  "style": "'white'",
                  "font": "'16px Rix'",
                  "align": "'center'"
                },
                "out": {
                  "services.graphics.shapes": "params.shapes"
                }
              }
            },
            {
              "send": {
                "pieces": "model.constants.level.pieces",
                "boxedPieces": "model.constants.level.boxedPieces",
                "goalReached": false,
                "selected": "model.constants.level.selected"
              }
            }
          ]
        },
        {
          "action": "doWhile",
          "params": {
            "in": {
              "value": "!model.goalReached"
            }
          },
          "children": [ 
            {
              "action": "drawLight",
              "params": {
                "in": {
                  "pieces": "model.pieces",
                  "constants": "model.constants",
                  "goalReached": "model.goalReached"
                },
                "out": {
                  "services.graphics.shapes": "params.shapes"
                }
              }
            },
            {
              "foreach": {
                "from": "model.pieces",
                "bindTo": "piece"
              },
              "children": [
                {
                  "action": "drawPiece",
                  "params": {
                    "in": {
                      "type" : "bindings.piece.type",
                      "row" : "bindings.piece.row",
                      "col" : "bindings.piece.col",
                      "rotation": "bindings.piece.rotation",
                      "constants": "model.constants",
                      "rotating": "@model.rotating",
                      "selectedPiece": "model.selectedPiece"
                    },
                    "out": {
                      "services.graphics.shapes": "params.shapes"
                    }
                  }
                }
              ]
            },
            {
              "foreach": {
                "from": "model.boxedPieces",
                "bindTo": "piece",
                "index": "pieceIndex"
              },
              "children": [
                {
                  "action": "drawBoxedPiece",
                  "params": {
                    "in": {
                      "type": "bindings.piece.type",
                      "index": "bindings.pieceIndex",
                      "constants": "model.constants" 
                    },
                    "out": {
                      "services.graphics.shapes": "params.shapes"
                    }
                  }
                }
              ]
            },
            {
              "action": "drawSelected",
              "params": {
                "in": {
                  "row": "model.selected.row",
                  "col": "model.selected.col",
                  "constants": "model.constants"
                },
                "out": {
                  "services.graphics.shapes": "params.shapes"
                }
              }
            },
            {
              "action": "clickListener",
              "params": {
                "in": {
                  "keyboard": "services.keyboard",
                  "mouse": "services.mouse",
                  "constants": "model.constants",
                  "selected": "model.selected",
                  "selectedPiece": "model.selectedPiece",
                  "draggedPiece": "model.draggedPiece",
                  "rotating": "model.rotating",
                  "originalRotation": "model.originalRotation",
                  "originalPieceRotation": "model.originalPieceRotation",
                  "pieces": "model.pieces",
                  "boxedPieces": "model.boxedPieces",
                  "leftMouseDown": "model.leftMouseDown"
                },
                "out": {
                  "services.graphics.shapes": "params.shapes",
                  "model.selected": "params.selected",
                  "model.selectedPiece": "params.selectedPiece",
                  "model.draggedPiece": "params.draggedPiece",
                  "model.rotating": "params.rotating",
                  "model.originalRotation": "params.originalRotation" ,
                  "model.originalPieceRotation": "params.originalPieceRotation",
                  "model.pieces": "params.pieces",
                  "model.boxedPieces": "params.boxedPieces",
                  "model.leftMouseDown": "params.leftMouseDown"
                }
              }
            },
            {
              "action": "rotateSelectedPiece",
              "params": {
                "in": {
                  "selected": "model.selected",
                  "keyboard": "services.keyboard",
                  "constants": "model.constants",
                  "pieces": "model.pieces"
                },
                "out": {
                  "model.pieces": "params.pieces"
                }
              }
            },
            {
              "action": "drawCursors",
              "params": {
                "in": {
                  "pieces": "model.pieces",
                  "boxedPieces": "model.boxedPieces",  
                  "constants": "model.constants",
                  "draggedPiece": "model.draggedPiece",
                  "mouse": "services.mouse"
                },
                "out": {
                  "services.mouse": "params.mouse"
                }
              }
            }
          ]
        },
        {
          "action": "doForSomeTime",
          "params": {
            "in": {
              "time": "model.constants.endingTime",
              "timer": "model.timer"
            },
            "out": {
              "model.timer": "params.timer"
            }
          },
          "children": [
            {
              "action": "drawText",
              "params": {
                "in": {
                  "text": "'You win'",
                  "x": 885,
                  "y": 150,
                  "style": "'white'",
                  "font": "'18px Rix'",
                  "align": "'center'"
                },
                "out": {
                  "services.graphics.shapes": "params.shapes"
                }
              } 
            },
            {
              "foreach": {
                "from": "model.pieces",
                "bindTo": "piece"
              },
              "children": [
                {
                  "action": "drawPiece",
                  "params": {
                    "in": {
                      "type" : "$piece.type",
                      "row" : "$piece.row",
                      "col" : "$piece.col",
                      "rotation": "$piece.rotation",
                      "constants": "model.constants"
                    },
                    "out": {  
                      "services.graphics": "params.graphics"
                    }
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
