{
  "action": "doInParallel",
  "children": [
    { 
      "send": {
        "services.graphics.shapes": "tools.drawShape({ type: 'image', asset: 'background', layer: 'bg', position: [0, 0] })" 
      }
    },
    {
      "action": "doInSequence",
      "params": {
        "in": {
          "activeChild": "model.topLevelActiveChild"
        },
        "out": {
          "model.topLevelActiveChild": "params.activeChild"
        }
      },
      "children": [
        {
          "action": "doForSomeTime",
          "params": {
            "in": {
              "time": "model.constants.startingTime",
              "timer": "model.timer"
            },
            "out": {
              "model.timer": "params.timer"
            }
          },
          "children": [
            { 
              "send": {
                "services.graphics.shapes": "tools.drawShape({ type: 'image', asset: 'title', layer: 'pieces', position: [100, 150] })" 
              }
            },
            {
              "send": {
                "services.graphics.shapes": "tools.drawShape({ type: 'text', text: 'Ready...', layer: 'text', position: [885, 150], strokeStyle: 'white', fillStyle: 'white', font: '16px Rix', align: 'center' })" 
              }
            },
            {
              "send": {
                "model.pieces": "model.constants.level.pieces",
                "model.boxedPieces": "model.constants.level.boxedPieces",
                "model.goalReached": false,
                "model.selected": "model.constants.level.selected"
              }
            }
          ]
        },
        {
          "action": "doWhile",
          "params": {
            "in": {
              "value": "!model.goalReached"
            }
          },
          "children": [ 
            {
              "action": "drawLight",
              "params": {
                "in": {
                  "pieces": "model.pieces",
                  "constants": "model.constants",
                  "goalReached": "model.goalReached"
                },
                "out": {
                  "services.graphics.shapes": "params.shapes",
                  "model.goalReached": "params.goalReached"
                }
              }
            },
            {
              "foreach": {
                "from": "model.pieces",
                "bindTo": "piece"
              },
              "children": [
                {
                  "send": {
                    "services.graphics.shapes": "tools.drawShape({ layer: 'pieces', type: 'image', asset: bindings.piece.type, position: [-50/2, -50/2], translation: tools.gridCellCenter(model.constants.boardGrid, [bindings.piece.col, bindings.piece.row]), rotation: bindings.piece.rotation })" 
                  }
                }
              ]
            },
            {
              "foreach": {
                "from": "model.boxedPieces",
                "bindTo": "piece",
                "index": "pieceIndex"
              },
              "children": [
                {
                  "send": {
                    "services.graphics.shapes": "tools.drawShape({ layer: 'pieces', type: 'image', asset: bindings.piece.type, position: [-50/2, -50/2], scale: 0.67, translation: tools.gridCellCenter(model.constants.boxGrid, tools.gridIndexToCell(bindings.pieceIndex)) })" 
                  }
                }
              ]
            },
            {
              "send": {
                "services.graphics.shapes": "tools.drawShape(_.extend(tools.gridCellRectangle(model.constants.boardGrid, [model.selected.col, model.selected.row]), { layer: 'selection', strokeStyle: 'yellow', lineWidth: 4 }))" 
              }
            },
            {
              "action": "clickListener",
              "params": {
                "in": {
                  "keyboard": "services.keyboard",
                  "mouse": "services.mouse",
                  "constants": "model.constants",
                  "selected": "model.selected",
                  "selectedPiece": "model.selectedPiece",
                  "draggedPiece": "model.draggedPiece",
                  "rotating": "model.rotating",
                  "originalRotation": "model.originalRotation",
                  "originalPieceRotation": "model.originalPieceRotation",
                  "pieces": "model.pieces",
                  "boxedPieces": "model.boxedPieces",
                  "leftMouseDown": "model.leftMouseDown"
                },
                "out": {
                  "services.graphics.shapes": "params.shapes",
                  "model.selected": "params.selected",
                  "model.selectedPiece": "params.selectedPiece",
                  "model.draggedPiece": "params.draggedPiece",
                  "model.rotating": "params.rotating",
                  "model.originalRotation": "params.originalRotation" ,
                  "model.originalPieceRotation": "params.originalPieceRotation",
                  "model.pieces": "params.pieces",
                  "model.boxedPieces": "params.boxedPieces",
                  "model.leftMouseDown": "params.leftMouseDown"
                }
              }
            },
            {
              "foreach": {
                "from": "model.pieces",
                "bindTo": "selectedPiece",
                "where": "model.selectedPiece && bindings.selectedPiece.col === model.selectedPiece.col && bindings.selectedPiece.row === model.selectedPiece.row && !_.contains(model.constants.unrotatablePieces, bindings.selectedPiece.type)"
              },
              "children": [
                {
                  "action": "changeParameterThroughKeyboard",
                  "params": {
                    "in": {
                      "parameter": "bindings.selectedPiece.rotation",
                      "keysDown": "services.keyboard.keysDown",
                      "keyMap": "model.constants.rotationKeyMap"
                    },
                    "out": {
                      "bindings.selectedPiece.rotation": "params.parameter"
                    }
                  }
                }
              ]
            }, 
            {
              "action": "if",
              "params": {
                "in": {
                  "value": "model.selectedPiece"
                }
              },
              "children": [
                {
                  "send": {
                    "services.graphics.shapes": "tools.drawShape({ layer: 'rotating', type: 'image', asset: model.rotating ? 'is-rotating' : 'can-rotate', scale: 0.5, position: [-208/2, -208/2], translation: tools.gridCellCenter(model.constants.boardGrid, [model.selectedPiece.col, model.selectedPiece.row]) })" 
                  }
                }
              ]
            },
            {
              "action": "if",
              "params": {
                "in": {
                  "value": "model.draggedPiece"
                }
              },
              "children": [
                {
                  "send": {
                    "services.mouse.cursor": "'move'",
                    "services.graphics.shapes": "tools.drawShape({ type: 'image', layer: 'drag', asset: model.draggedPiece.type, alpha: 0.5, position: [-model.constants.pieceAssetCentering, -model.constants.pieceAssetCentering], translation: services.mouse.position, rotation: model.draggedPiece.rotation })"
                  }
                },
                {
                  "action": "if",
                  "params": {
                    "in": {
                      "value": "tools.findGridElement(tools.gridCellAtPoint(model.constants.boardGrid, services.mouse.position), model.pieces) || tools.gridCellToIndex(model.boxedPieces, tools.gridCellAtPoint(model.constants.boxGrid, services.mouse.position))"
                    }
                  },
                  "children": [
                    {
                      "send": {
                        "services.mouse.cursor": "'pointer'"
                      }  
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "action": "doForSomeTime",
          "params": {
            "in": {
              "time": "model.constants.endingTime",
              "timer": "model.timer"
            },
            "out": {
              "model.timer": "params.timer"
            }
          },
          "children": [
            {
              "send": {
                "services.graphics.shapes": "tools.drawShape({ type: 'text', text: 'You win', layer: 'text', position: [885, 150], strokeStyle: 'white', fillStyle: 'white', font: '18px Rix', align: 'center' })" 
              }
            },
            {
              "foreach": {
                "from": "model.pieces",
                "bindTo": "piece"
              },
              "children": [
                {
                  "send": {
                    "services.graphics.shapes": "tools.drawShape({ layer: 'pieces', type: 'image', asset: bindings.piece.type, position: [-50/2, -50/2], translation: tools.gridCellCenter(model.constants.boardGrid, [bindings.piece.col, bindings.piece.row]), rotation: bindings.piece.rotation })" 
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
